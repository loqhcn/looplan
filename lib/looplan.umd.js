(function(i,o){typeof exports=="object"&&typeof module<"u"?o(exports,require("vue"),require("lodash"),require("axios")):typeof define=="function"&&define.amd?define(["exports","vue","lodash","axios"],o):(i=typeof globalThis<"u"?globalThis:i||self,o(i.looplan={},i.Vue,i.lodash,i.axios))})(this,function(i,o,C,A){"use strict";var Q=Object.defineProperty;var X=(i,o,C)=>o in i?Q(i,o,{enumerable:!0,configurable:!0,writable:!0,value:C}):i[o]=C;var E=(i,o,C)=>X(i,typeof o!="symbol"?o+"":o,C);function O(r,e=!0){if(typeof r!="string")return"";let n=r.replace(/([a-z])([A-Z])/g,"$1 $2").replace(/[^a-zA-Z0-9]+/g," ").split(" ");n=n.filter(s=>s!=="");for(let s=0;s<n.length;s++)s===0&&!e?n[s]=n[s].toLowerCase():n[s]=n[s].charAt(0).toUpperCase()+n[s].slice(1).toLowerCase();return n.join("")}function L(r){return{title:r,name:r,modelType:"none"}}const y={MuloLayer:{name:"MuloLayer",title:"MuloLayer",type:"cdn",version:"v1",cdn:"http://component.loqh.cn/mulo-layer/__version__/mulo-layer.umd.js",styleCdn:[],components:[{title:"测试组件",name:"MuloTest",modelType:"none"}],loadStatus:0}},g={},p={};class k{constructor(){E(this,"components",{})}parseComponentName(e){const[t,n]=e.split("@");return`${t}@${O(n)}`}async component(e,t=null){const n=this.parseComponentName(e);if(t){this.components[n]=t;return}console.debug("加载组件",n);const[s,c]=n.split("@");if(!g[s]){const m=await this.getPackage(s);this.registerComponents(y[s],m)}const d=this.getComponentOption(n);return d&&d.styleImportCase==="use"&&d.styleCdn&&await this.loadComponentStyles(s,d),this.isAsyncComponent(s,c)?(console.debug("加载异步组件",n),this.components[n]()):this.components[n]}getComponentOptionObject(e){return typeof e=="string"?L(e):e}registerComponents(e,t){console.log("注册组件包",e.name,t),e.components.forEach(n=>{const s=this.getComponentOptionObject(n),c=O(s.name),d=`${e.name}@${c}`;console.log("注册组件",d,t[c]),this.components[d]=t[c]})}getComponentOption(e){const t=this.parseComponentName(e),[n,s]=t.split("@"),c=y[n];if(!c)return;const d=c.components.find(m=>{const u=this.getComponentOptionObject(m);return O(u.name)===s});return d?this.getComponentOptionObject(d):void 0}isAsyncComponent(e,t){const n=y[e];if(!n)return!1;if(n.asyncComponents)return n.asyncComponents.includes(t);const s=n.components.find(c=>{const d=this.getComponentOptionObject(c);return O(d.name)===t});return s?!!this.getComponentOptionObject(s).isAsync:!1}async getPackage(e){console.debug("getPackage 加载组件包",e);const t=y[e];if(!t)throw new Error(`组件包不存在: ${e}`);if(g[e])return g[e];if(t.type==="cdn"){if(t.loadStatus===-1&&(t.loadStatus=0),t.loadStatus===0){t.loadStatus=1;try{t.styleCdn&&t.styleCdn.length>0&&t.styleImportCase==="register"&&await this.loadPackageStyles(e);const n=await this.getOnlineComponentPackage(t);g[e]=n,t.loadStatus=200}catch(n){throw t.loadStatus=-1,n}}t.loadStatus===1&&await this.waitComputeLoad(e)}return g[e]}waitComputeLoad(e){return new Promise(t=>{const n=setInterval(()=>{g[e]&&(clearInterval(n),t())},100)})}addLocalPackage(e,t){y[e.name]=e,g[e.name]=t,this.registerComponents(e,t)}registerPackage(e){e=Object.assign({loadStatus:0,styleImportCase:"register"},e),y[e.name]=e}getOnlineComponentPackage(e){return new Promise((t,n)=>{console.debug(`开始加载在线组件库: %c${e.name}`,"color: blue");const{title:s,name:c,version:d,cdn:m}=e;if(!m){n(new Error(`组件库 ${c} 未设置 CDN 地址`));return}const u=m.replace("__version__",d||""),a=document.createElement("script");a.src=u,a.onload=()=>{window[c]?(console.debug(`已加载在线组件库: %c${c}`,"color: green"),t(window[c]),e.keepOfWindow||delete window[c]):n(new Error(`组件未在全局命名空间中找到: ${c}`)),document.body.removeChild(a)},a.onerror=()=>{document.body.removeChild(a),n(new Error(`加载 ${s||c} 组件库失败`))},document.body.appendChild(a)})}loadPackageStyles(e){const t=y[e];if(!t||!t.styleCdn||t.styleCdn.length===0)return Promise.resolve();console.debug(`加载组件包样式: %c${e}`,"color: blue");const n=t.version||"";p[e]||(p[e]=[]);const s=t.styleCdn.map(c=>new Promise((d,m)=>{const u=c.replace("__version__",n),a=document.createElement("link");a.rel="stylesheet",a.href=u,a.onload=()=>{console.debug(`已加载样式: %c${u}`,"color: green"),d(a)},a.onerror=()=>{console.error(`加载包样式失败: ${u}`),document.head.removeChild(a),m(new Error(`加载 ${t.title||e} 样式失败: ${u}`))},document.head.appendChild(a),p[e].push(a)}));return Promise.all(s).then(()=>{})}async loadComponentStyles(e,t){if(!t.styleCdn||t.styleCdn.length===0)return;console.debug(`加载组件特定样式: %c${e}@${t.name}`,"color: blue");const n=y[e],s=(n==null?void 0:n.version)||"",c=`${e}@${t.name}`;p[c]||(p[c]=[]);const d=t.styleCdn.map(u=>new Promise(a=>{const h=u.replace("__version__",s),l=document.createElement("link");l.rel="stylesheet",l.href=h,l.onload=()=>{console.debug(`已加载组件样式: %c${h}`,"color: green"),a(l)},l.onerror=()=>{console.error(`加载组件样式失败: ${h}`),document.head.removeChild(l),a(null)},document.head.appendChild(l),p[c].push(l)})),m=await Promise.all(d);p[c]=p[c].filter(u=>m.includes(u))}unloadPackageStyles(e){p[e]&&(p[e].forEach(t=>{document.head.contains(t)&&document.head.removeChild(t)}),delete p[e]),Object.keys(p).forEach(t=>{t.startsWith(`${e}@`)&&(p[t].forEach(n=>{document.head.contains(n)&&document.head.removeChild(n)}),delete p[t])})}unloadComponentStyles(e){const t=this.parseComponentName(e);p[t]&&(p[t].forEach(n=>{document.head.contains(n)&&document.head.removeChild(n)}),delete p[t])}getLoadedStyleLinks(){return p}}const w=new k,I={class:"m-tip"},j=o.defineComponent({__name:"asyncLoading",setup(r){const e=o.getCurrentInstance();return console.log("loading instance",e),o.reactive({}),(t,n)=>(o.openBlock(),o.createElementBlock("div",I," Loading... "))}}),V={"[object Number]":"number","[object String]":"string","[object Boolean]":"bool","[object Array]":"array","[object Object]":"object","[object Undefined]":"undefined","[object Function]":"function","[object RegExp]":"regexp","[object Date]":"date","[object Symbol]":"symbol"};class T{static typeof(e){let t=Object.prototype.toString.call(e);return V[t]||"unknow"}static isArray(e){return Object.prototype.toString.call(e)==="[object Array]"}static isEmpty(e){return e==null?!0:typeof e=="string"?e.trim()==="":Array.isArray(e)?e.length===0:typeof e=="object"?Object.keys(e).length===0:!1}static copyObj(e){return JSON.parse(JSON.stringify(e))}}function U(r){return typeof r!="string"?!1:r.match(/^[a-zA-Z0-9-]+@[a-zA-Z0-9-_]+$/)}function q(r){console.log("%c设置组件包","color:green;",r),w.addLocalPackage(r.packageConfig,r)}function B(r){console.debug("%c注册组件包","color:green;",r),w.registerPackage(r)}function M(r=500){return o.defineAsyncComponent({loader:()=>new Promise(async(e,t)=>{try{setTimeout(()=>{e(function(){return""})},r)}catch(n){t(n)}})})}function z(r){return w.getComponentOption(r)}function S(r,e={}){r=w.parseComponentName(r);const t=Object.assign({errorComponent:function(n){return`组件加载失败:${r}`},loadingComponent:j},e);return o.defineAsyncComponent({loader:()=>new Promise(async(n,s)=>{try{console.debug("-- 加载组件:",r);let c=await w.component(r);if(!c){s(new Error("组件不存在:"+r));return}n(c)}catch(c){s(c)}}),...t})}const D={key:1,class:"m-component-error"},R={class:"error-msg"},x={name:"lp-component",inheritAttrs:!1},P=o.defineComponent({...x,props:{is:{type:String,default:""}},setup(r){const e=r,t=o.ref(!1),n=o.ref("");let s=null;const c=S(e.is,{loadingComponent:j,errorComponent:function(l){return""},onError:(l,f,_,b)=>{console.error("onError",b),s=f,t.value=!0,n.value=`组件加载失败: ${l.message}`,_()}});o.watch(()=>e.is,(l,f)=>{});function d(){t.value=!1,n.value="",s==null||s()}o.onErrorCaptured((l,f,_)=>(console.log("onErrorCaptured",l,f,_),!1));const m=o.useAttrs(),u=o.useSlots();console.log("$slots",u),console.log("$attrs",m);const a=o.computed(()=>Object.keys(m).reduce((l,f)=>(f.startsWith("on")||(l[f]=m[f]),l),{})),h=o.computed(()=>Object.keys(m).reduce((l,f)=>{if(f.startsWith("on")){const _=f.slice(2).replace(/^\w/,b=>b.toLowerCase());l[_]=m[f]}return l},{}));return o.computed(()=>{const l={};return"modelValue"in m&&(l.modelValue=m.modelValue),l}),o.computed(()=>{const l={};return"onUpdate:modelValue"in m&&(l["update:modelValue"]=m["onUpdate:modelValue"]),l}),console.log("filteredAttrs",a.value),console.log("formattedListeners",h.value),(l,f)=>(o.openBlock(),o.createElementBlock(o.Fragment,null,[r.is?(o.openBlock(),o.createBlock(o.resolveDynamicComponent(o.unref(c)),o.mergeProps({key:0},a.value,o.toHandlers(h.value)),o.createSlots({_:2},[o.renderList(o.unref(u),(_,b)=>({name:b,fn:o.withCtx(G=>[o.renderSlot(l.$slots,b,o.normalizeProps(o.guardReactiveProps(G||{})))])}))]),1040)):o.createCommentVNode("",!0),t.value?(o.openBlock(),o.createElementBlock("div",D,[o.createElementVNode("div",R,o.toDisplayString(n.value),1),o.createElementVNode("button",{class:"btn btn-primary link",onClick:o.withModifiers(d,["stop"])},"重试")])):o.createCommentVNode("",!0)],64))}}),J=Object.freeze(Object.defineProperty({__proto__:null,default:{install:r=>{r.component(P.name,P)}}},Symbol.toStringTag,{value:"Module"})),W=Object.freeze(Object.defineProperty({__proto__:null},Symbol.toStringTag,{value:"Module"}));function $(r){const e=Object.assign({"./lp-component/index.ts":J,"./lp-upload/index.ts":W});console.debug("%cglobalComponents","color:green",e),Object.keys(e).forEach(t=>{const n=e[t].default;C.isEmpty(n)||r.use(n)})}const Z={class:"m-layout"},F={name:"UploadComponent"},v=o.defineComponent({...F,setup(r){return o.reactive({}),(e,t)=>(o.openBlock(),o.createElementBlock("div",Z," 上传组件待开发 "))}});function H(r){r=r||{};const e=A.create({baseURL:r.baseURL,timeout:r.timeout||1e4,headers:{...r.headers||{}}});return r.requestInterceptors&&e.interceptors.request.use(r.requestInterceptors,t=>(console.log("request",{err:t}),Promise.reject(t))),r.responseInterceptors&&e.interceptors.response.use(r.responseInterceptors,t=>(console.log("response err",{err:t}),Promise.reject(t))),r.baseInterceptors&&!(r.requestInterceptors||r.responseInterceptors)&&(e.interceptors.request.use(t=>(console.log("request",{config:t}),t)),e.interceptors.response.use(t=>(console.log("response",{response:t}),t.data))),e}const K={install(r){$(r)}};i.JsDataType=T,i.UploadComponent=v,i.asyncComponentDelay=M,i.createApi=H,i.default=K,i.getComponentOption=z,i.loadComponent=S,i.nameIsUseAsyncComponent=U,i.registerLooplanComponents=$,i.registerPackage=B,i.setComponentPackage=q,Object.defineProperties(i,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
